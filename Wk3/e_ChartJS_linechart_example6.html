<!DOCTYPE html>
<html>
<head>
<title>World's Largest Urban Agglomerations Line Chart</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

<!--Load Chart.JS and D3 to parse the CSV file-->
<script charset="utf-8" src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>    
    #chartContainer {width: 840px; margin: auto; margin-top: 50px; }
    #chartContainer p {margin-left: 60px; margin-bottom: 5px; margin-top: 0; padding: 0;}
    #charttitle {font: bold 22px  Verdana, sans-serif;}
</style>

</head>

    
<body>

<!--This is the div container for the chart-->

<div id="chartContainer">
      
    <p id="charttitle">Chart title is here</p>
    <p id="chartsubhead">Population 1970-2050. Data UN World Urbanization Prospects.</p>
    
   <p><select id="CityMenu"><option>Change City Here:</option></select></p>  <!-- This is the drop down menu to select different cities-->

    <canvas id="myChart"></canvas>

</div>


<script>


//This statement loads the data from the CSV file, and then runs the function after the CSV is loaded. CityArray is an array that contains the CSV data

    d3.csv("CityData_WUP2025_top200.csv").then(function(CityArray) {
           
        var chartdata;
         
          
        var cityMenu = document.getElementById("CityMenu"); 
     
        for(var i = 0; i < CityArray.length; i++) {            // In this loop we add the names of all the Cities in the CSV to the drop down menu
            var el = document.createElement("option");
            el.textContent = CityArray[i].Name + ", " + CityArray[i].Country;
            el.value = i;
            cityMenu.appendChild(el);
            }       
        


        const ctx = document.getElementById('myChart');
        
        var CityName;
        var PopulationData;
        var CityData;


          function SetCityData(index) {   // Function that extracts the population timeseries for the selected city

                CityData = CityArray[index];
                CityName = CityData.Name;
                console.log(CityData); // Show the data of the row in the console

                document.getElementById("charttitle").innerHTML = CityData.CityName + ",&nbsp;" + CityData.Country; // The name of the city and country is inserted into the chart title

                PopulationData = [CityData.pop1980,CityData.pop1990,CityData.pop2000,CityData.pop2010,CityData.pop2020,CityData.pop2030,CityData.pop2040,CityData.pop2050];
                console.log(PopulationData);

        }
        
        SetCityData(0);
        

        var labels = ["1980","1990","2000","2010","2020","2030","2040","2050"];

        var chart = new Chart(ctx, {
            type: 'line',
            data: {
            labels : labels,
            datasets: [
                {
                label: CityName,
                data: PopulationData 
                }
            ]
            },
            options: {
                plugins: {
                legend: {
                    position: 'right'
                }
                },
            scales: {
                y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Population (millions)'
                }
                }
            }
            }
        });


       document.getElementById("CityMenu").onchange = function() {    // This is the event listener that runs when the user changes the menu
            var x = document.getElementById("CityMenu").value;

            SetCityData(x);   // Run the function that will update chartdata with the user selected city
            
            chart.data.datasets.forEach((dataset) => {  // Update the chart with the new data
                dataset.data = PopulationData;
                dataset.label = CityName;
            });
            chart.update();
         }       
    
          
          
      });


</script>

</body>
</html>